{% extends "layouts/base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}Reporte Completo{% endblock %}

{% block content %}
<div class="pc-container">
  <div class="pc-content">

    <div class="container py-4">
      <h2 class="text-center mb-4">Reporte Completo: Productos, Compras y Ventas</h2>

      <button class="btn btn-primary mb-3" onclick="imprimirReporteCompleto()">üñ®Ô∏è Imprimir Reporte Completo</button>

      <div id="reporte-completo">

        <!-- SECCI√ìN PRODUCTOS -->
        <h3 class="mt-4">Productos</h3>
        <table class="table table-bordered table-hover">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Descripci√≥n</th>
              <th>Categor√≠a</th>
              <th>Precio Compra</th>
              <th>Precio Venta</th>
              <th>Cantidad</th>
              <th>Unidad de Medida</th>
            </tr>
          </thead>
          <tbody>
            {% for producto in productos %}
            <tr>
              <td>{{ producto.id }}</td>
              <td>{{ producto.nombre }}</td>
              <td>{{ producto.descripcion }}</td>
              <td>{{ producto.categoria }}</td>
              <td>Bs. {{ producto.precio_compra|floatformat:2 }}</td>
              <td>Bs. {{ producto.precio_venta|floatformat:2 }}</td>
              <td>{{ producto.cantidad }}</td>
              <td>{{ producto.unidad_medida }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <p><strong>Total Productos: {{ productos|length }}</strong></p>

        <!-- SECCI√ìN COMPRAS -->
        <h3 class="mt-5">Compras</h3>
        <table class="table table-bordered table-hover">
          <thead class="table-light">
            <tr>
              <th>ID Compra</th>
              <th>Fecha</th>
              <th>Proveedor</th>
              <th>Usuario</th>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Precio Unitario</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody>
            {% for compra in compras %}
              {% for d in compra.detalles.all %}
              <tr>
                <td>{{ compra.id }}</td>
                <td>{{ compra.fecha }} {{ compra.hora|time:"H:i" }}</td>
                <td>{{ compra.proveedor }}</td>
                <td>{{ compra.usuario }}</td>
                <td>{{ d.producto.nombre }}</td>
                <td>{{ d.cantidad }}</td>
                <td>Bs. {{ d.precio|floatformat:2 }}</td>
                <td>Bs. {{ d.precio|mul:d.cantidad|floatformat:2 }}</td>
              </tr>
              {% endfor %}
            {% endfor %}
          </tbody>
        </table>
        <p><strong>Total Compras: Bs. {{ total_compras|floatformat:2 }}</strong></p>

        <!-- SECCI√ìN VENTAS -->
        <h3 class="mt-5">Ventas</h3>
        <table class="table table-bordered table-hover">
          <thead class="table-light">
            <tr>
              <th>ID Venta</th>
              <th>Fecha</th>
              <th>Cliente</th>
              <th>Usuario</th>
              <th>M√©todo de Pago</th>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Precio Unitario</th>
              <th>Descuento</th>
              <th>Subtotal</th>
              <th>Ganancia</th>
            </tr>
          </thead>
          <tbody>
            {% for venta in ventas %}
              {% for d in venta.detalles.all %}
              <tr>
                <td>{{ venta.id }}</td>
                <td>{{ venta.fecha }} {{ venta.hora|time:"H:i" }}</td>
                <td>{{ venta.cliente }}</td>
                <td>{{ venta.usuario }}</td>
                <td>{{ venta.get_metodo_pago_display }}</td>
                <td>{{ d.producto.nombre }}</td>
                <td>{{ d.cantidad }}</td>
                <td>Bs. {{ d.precio_unitario|floatformat:2 }}</td>
                <td>Bs. {{ d.descuento|floatformat:2 }}</td>
                <td>Bs. {{ d.subtotal|floatformat:2 }}</td>
                <td>Bs. {{ d.ganancia_total|floatformat:2 }}</td>
              </tr>
              {% endfor %}
            {% endfor %}
          </tbody>
        </table>
        <p><strong>Total Ventas: Bs. {{ total_ventas|floatformat:2 }}</strong></p>

      </div>

    </div>
  </div>
</div>

<script>
function imprimirReporteCompleto() {
  const contenido = document.getElementById('reporte-completo').innerHTML;
  const logoURL = `${window.location.origin}/static/img/logo.jpg`;

  const ventana = window.open('', '_blank');
  ventana.document.write(`
    <html>
      <head>
        <title>Reporte Completo</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
          @page { size: Letter; margin: 2cm; }
          @media print {
            body { font-size: 12pt; margin:0; }
            table { width: 100%; border-collapse: collapse; margin-top: 1em; }
            table, th, td { border: 1px solid #000; }
            th, td { padding: 6px; text-align: left; }
            .print-header, .print-footer { text-align: center; }
            .print-header img { max-width: 150px; margin-bottom: 10px; }
            hr { margin: 10px 0; }
          }
        </style>
      </head>
      <body class="p-4">
        <div class="print-header">
          <img src="${logoURL}" alt="Logo de la empresa">
          <h3>{{ configuracion.nombre_negocio }}</h3>
            <p>Direcci√≥n: {{ configuracion.direccion }}</p>
            <p>Tel√©fono: {{ configuracion.telefono }}</p>
            <p>NIT: {{ configuracion.nit }}</p>
          <hr>
        </div>

        ${contenido}

        <div class="print-footer mt-4">
          <p>Reporte generado autom√°ticamente.</p>
        </div>

        <script>
          window.onload = function() { 
            window.print(); 
            window.onafterprint = function(){ window.close(); } 
          }
        <\/script>
      </body>
    </html>
  `);
  ventana.document.close();
}
</script>

{% endblock content %}
