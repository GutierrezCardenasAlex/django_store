{% extends "layouts/base.html" %}
{% load static %}
{% block title %}Reporte de Ventas{% endblock %}

{% block content %}
<div class="pc-container">
  <div class="pc-content">

    <div class="container py-4">

      <h2 class="text-center mb-4">Reporte de Ventas</h2>

      <button class="btn btn-primary mb-3" onclick="imprimirReporteVentas()">üñ®Ô∏è Imprimir Ventas</button>

      <div id="reporte-ventas">
        <table class="table table-bordered table-hover">
          <thead class="table-light">
            <tr>
              <th>ID Venta</th>
              <th>Fecha</th>
              <th>Cliente</th>
              <th>Usuario</th>
              <th>M√©todo de Pago</th>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Precio Unitario</th>
              <th>Descuento</th>
              <th>Subtotal</th>
              <th>Ganancia</th>
            </tr>
          </thead>
          <tbody>
            {% for venta in ventas %}
              {% for d in venta.detalles.all %}
              <tr>
                <td>{{ venta.id }}</td>
                <td>{{ venta.fecha }} {{ venta.hora|time:"H:i" }}</td>
                <td>{{ venta.cliente }}</td>
                <td>{{ venta.usuario }}</td>
                <td>{{ venta.get_metodo_pago_display }}</td>
                <td>{{ d.producto.nombre }}</td>
                <td>{{ d.cantidad }}</td>
                <td>Bs. {{ d.precio_unitario|floatformat:2 }}</td>
                <td>Bs. {{ d.descuento|floatformat:2 }}</td>
                <td>Bs. {{ d.subtotal|floatformat:2 }}</td>
                <td>Bs. {{ d.ganancia_total|floatformat:2 }}</td>
              </tr>
              {% endfor %}
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<script>
function imprimirReporteVentas() {
  const contenido = document.getElementById('reporte-ventas').innerHTML;
  const logoURL = `${window.location.origin}/static/img/logo.jpg`;

  const ventana = window.open('', '_blank'); // Abrir en otra pesta√±a
  ventana.document.write(`
    <html>
      <head>
        <title>Reporte de Ventas</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
          @page { size: Letter; margin: 2cm; }
          @media print {
            body { font-size: 12pt; margin:0; }
            table { width: 100%; border-collapse: collapse; margin-top: 1em; }
            table, th, td { border: 1px solid #000; }
            th, td { padding: 6px; text-align: left; }
            .print-header, .print-footer { text-align: center; }
            .print-header img { max-width: 150px; margin-bottom: 10px; }
            hr { margin: 10px 0; }
          }
        </style>
      </head>
      <body class="p-4">
        <div class="print-header">
          <img src="${logoURL}" alt="Logo de la empresa">
           <h3 class="mb-1">{{ configuracion.nombre_negocio }}</h3>
      <hr class="my-2" style="width: 50px; border-top: 3px solid #007bff;">
      
      <!-- Informaci√≥n adicional abajo -->
      <div class="mt-3 text-center">
        <p class="mb-1"><strong>Direcci√≥n:</strong> {{ configuracion.direccion }}</p>
        <p class="mb-1"><strong>Tel√©fono:</strong> {{ configuracion.telefono }}</p>
        <p class="mb-1"><strong>NIT:</strong> {{ configuracion.nit }}</p>
      </div>
      <hr>
        </div>

        ${contenido}

        <div class="print-footer mt-4">
          <p>Reporte generado autom√°ticamente.</p>
        </div>

        <script>
          window.onload = function() { 
            window.print(); 
            window.onafterprint = function(){ window.close(); } 
          }
        <\/script>
      </body>
    </html>
  `);
  ventana.document.close();
}
</script>

{% endblock content %}
